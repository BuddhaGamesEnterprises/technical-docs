

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Making a Shelley blockchain from scratch &mdash; Cardano Documentation 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="https://unpkg.com/mermaid@8.4.8/dist/mermaid.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Cardano Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cardano-explained/index.html">Cardano Explained</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cardano-components.html">Cardano Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute-cardano.html">Contribute to Cardano Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get-support.html">Get Support</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cardano Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Making a Shelley blockchain from scratch</li>
    
    

  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="making-a-shelley-blockchain-from-scratch">
<h1>Making a Shelley blockchain from scratch<a class="headerlink" href="#making-a-shelley-blockchain-from-scratch" title="Permalink to this headline">¶</a></h1>
<p><strong>Last validated: 2020/05/10</strong></p>
<div class="section" id="preliminaries">
<h2>Preliminaries<a class="headerlink" href="#preliminaries" title="Permalink to this headline">¶</a></h2>
<p>This assumes that you already have built and installed the executables from
this repository. So <code class="docutils literal notranslate"><span class="pre">cardano-cli</span></code> and <code class="docutils literal notranslate"><span class="pre">cardano-node</span></code> should be on your <code class="docutils literal notranslate"><span class="pre">$PATH</span></code>.</p>
<p>We also assume a Linux system, though it should work fine on OSX too.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli version
cardano-cli 1.11.0 - linux-x86_64 - ghc-8.6
</pre></div>
</div>
<p>Everything we’ll be doing uses the <code class="docutils literal notranslate"><span class="pre">shelley</span></code> sub-command</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley
Usage: cardano-cli shelley COMMAND
  Shelley specific commands

Available options:
  -h,--help                Show this help text

Available commands:
  address                  Shelley address commands
  stake-address            Shelley stake address commands
  transaction              Shelley transaction commands
  node                     Shelley node operaton commands
  stake-pool               Shelley stake pool commands
  query                    Shelley node query commands
  block                    Shelley block commands
  system                   Shelley system commands
  governance               Shelley governance commands
  genesis                  Shelley genesis block commands
</pre></div>
</div>
<p>We’ll put all files under an <code class="docutils literal notranslate"><span class="pre">example</span></code> directory.</p>
</div>
<div class="section" id="making-a-genesis-file-manually">
<h2>Making a genesis file manually<a class="headerlink" href="#making-a-genesis-file-manually" title="Permalink to this headline">¶</a></h2>
<p>To start a new blockchain we of course need a genesis file. A Shelley genesis
file is JSON file.</p>
<p>There is a manual method and a semi-automagic method, but we’ll start by
explaining the manual method since that makes it easier to explain what the
things are and what they are for. So read this section even if you want to use
the automagic method.</p>
<p>So when doing it for real, we have to use the manual method since the different
steps are run by different people in different locations.</p>
<p>A real chain should use several genesis keys, and they should be created
separately by the members of the federation bootstrapping the system. They
should be created offline, kept offline and only the verification keys shared.</p>
<p>For a demo we’re going to put all the keys together in once place</p>
<p>To start with we will set up our template directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis create --genesis-dir example/
</pre></div>
</div>
<p>This gives us</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls example/*
example/genesis.json  example/genesis.spec.json

example/delegate-keys:

example/genesis-keys:

example/utxo-keys:
</pre></div>
</div>
<p>Note that it created both a <code class="docutils literal notranslate"><span class="pre">genesis.spec.json</span></code> and a <code class="docutils literal notranslate"><span class="pre">genesis.json</span></code>. This
command can be re-run at any time and it will re-generate the <code class="docutils literal notranslate"><span class="pre">genesis.json</span></code>
based on the <code class="docutils literal notranslate"><span class="pre">genesis.spec.json</span></code> (which we can edit by hand) and any keys
placed in the three sub-directories.</p>
<p>Our next steps will be to create the various keys, adjust the
<code class="docutils literal notranslate"><span class="pre">genesis.spec.json</span></code> to our liking and re-generate the <code class="docutils literal notranslate"><span class="pre">genesis.json</span></code>.</p>
<div class="section" id="genesis-keys">
<h3>Genesis keys<a class="headerlink" href="#genesis-keys" title="Permalink to this headline">¶</a></h3>
<p>Shelley supports decentralised block production but not yet decentralised
governance, so we still have genesis keys with special governance powers.</p>
<p>So the first step will be to make the genesis keys.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis key-gen-genesis
Usage: cardano-cli shelley genesis key-gen-genesis --verification-key-file FILEPATH
                                                   --signing-key-file FILEPATH
  Create a Shelley genesis key pair

Available options:
  --verification-key-file FILEPATH
                           Output filepath of the verification key.
  --signing-key-file FILEPATH
                           Output filepath of the signing key.
</pre></div>
</div>
<p>So let’s make two example genesis key pairs</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis key-gen-genesis \
    --verification-key-file example/genesis-keys/genesis1.vkey \
    --signing-key-file example/genesis-keys/genesis1.skey
$ cardano-cli shelley genesis key-gen-genesis \
    --verification-key-file example/genesis-keys/genesis2.vkey \
    --signing-key-file example/genesis-keys/genesis2.skey
</pre></div>
</div>
</div>
<div class="section" id="semi-readable-file-formats">
<h3>Semi-readable file formats<a class="headerlink" href="#semi-readable-file-formats" title="Permalink to this headline">¶</a></h3>
<p>You can look at these files, they are semi-readable</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat example/genesis-keys/genesis1.vkey
type: Genesis verification key
title: Genesis key
cbor-hex:
 582066361ff2e1b5fdf25bc14bc48424b64fa62cee7692ed7e86216eafd3bdb28cbd
</pre></div>
</div>
<p>The “type” must not be edited. This is used as a sanity check. The “title”
field is free-form and you can use it for whatever purpose you like, such as
identifying different keys. Don’t edit the binary data of course, but you
can inspect it using any CBOR tool, e.g. <a class="reference external" href="http://cbor.me/">cbor.me</a> or the <code class="docutils literal notranslate"><span class="pre">cardano-cli</span></code>
itself:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cardano</span><span class="o">-</span><span class="n">cli</span> <span class="n">shelley</span> <span class="n">text</span><span class="o">-</span><span class="n">view</span> <span class="n">decode</span><span class="o">-</span><span class="n">cbor</span>
<span class="n">Usage</span><span class="p">:</span> <span class="n">cardano</span><span class="o">-</span><span class="n">cli</span> <span class="n">shelley</span> <span class="n">text</span><span class="o">-</span><span class="n">view</span> <span class="n">decode</span><span class="o">-</span><span class="n">cbor</span> <span class="o">--</span><span class="n">file</span> <span class="n">FILENAME</span>
  <span class="n">Print</span> <span class="n">a</span> <span class="n">TextView</span> <span class="n">file</span> <span class="k">as</span> <span class="n">decoded</span> <span class="n">CBOR</span><span class="o">.</span>

<span class="n">Available</span> <span class="n">options</span><span class="p">:</span>
  <span class="o">--</span><span class="n">file</span> <span class="n">FILENAME</span>          <span class="n">Input</span> <span class="n">file</span><span class="o">.</span>
</pre></div>
</div>
<p>Like so</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley text-view decode-cbor \
    --file example/genesis-keys/genesis1.vkey

58 20 46 4e f4 95 59 f4 e3 6f b7 02 1f cb 12 71
c5 ba 84 f3 66 22 0a 15 0e 66 bb a8 71 87 2f 27
7c ed  # bytes(32)
</pre></div>
</div>
<p>So we can see this is just a 32 byte string. Not surprising, since this is of
course just an ed25519 verification key.</p>
</div>
<div class="section" id="genesis-delegate-keys">
<h3>Genesis delegate keys<a class="headerlink" href="#genesis-delegate-keys" title="Permalink to this headline">¶</a></h3>
<p>When we start a Shelley blockchain it will not be in decentralised block
production mode. Initially all blocks will be created by designated genesis
delegate nodes in the BFT overlay schedule. These genesis delegate nodes are
similar to stake pool nodes (but take part in the BFT overlay and don’t get
rewards). The genesis file contains a special mapping from genesis keys to
genesis delegate keys.</p>
<p>So we need to make genesis delegate keys, as many as you made genesis keys
(just two in our example).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis key-gen-delegate
Usage: cardano-cli shelley genesis key-gen-delegate --verification-key-file FILEPATH
                                                    --signing-key-file FILEPATH
                                                    --operational-certificate-issue-counter FILE
  Create a Shelley genesis delegate key pair

Available options:
  --verification-key-file FILEPATH
                           Output filepath of the verification key.
  --signing-key-file FILEPATH
                           Output filepath of the signing key.
  --operational-certificate-issue-counter FILE
                           The file with the issue counter for the operational
                           certificate.
</pre></div>
</div>
<p>Much the same as for genesis keys, but there is an additional output, the
operational certificate issue counter. We will talk about this later.</p>
<p>Let’s make two genesis delegate key pairs, to use with our two genesis keys</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis key-gen-delegate \
    --verification-key-file example/delegate-keys/delegate1.vkey \
    --signing-key-file example/delegate-keys/delegate1.skey \
    --operational-certificate-issue-counter example/delegate-keys/delegate-opcert1.counter
$ cardano-cli shelley genesis key-gen-delegate \
    --verification-key-file example/delegate-keys/delegate2.vkey \
    --signing-key-file example/delegate-keys/delegate2.skey \
    --operational-certificate-issue-counter example/delegate-keys/delegate-opcert2.counter
</pre></div>
</div>
<p>Let’s see what’s in that counter file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat example/delegate-keys/delegate-opcert1.counter
type: Node operational certificate issue counter
title: Next certificate issue number: 0
cbor-hex:
 00
</pre></div>
</div>
<p>Yes, we count from zero. We will talk about what this counter is for later.</p>
</div>
<div class="section" id="initial-utxo">
<h3>Initial UTxO<a class="headerlink" href="#initial-utxo" title="Permalink to this headline">¶</a></h3>
<p>We need to start the system with some money or it will be very boring. The
genesis file can list number of initial addresses and values, but we need
keys for those addresses and later to sign transactions to spend the initial
UTxO values.</p>
<p>So we need to make genesis initial UTxO keys.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis key-gen-utxo
Usage: cardano-cli shelley genesis key-gen-utxo --verification-key-file FILEPATH
                                                --signing-key-file FILEPATH
  Create a Shelley genesis UTxO key pair

Available options:
  --verification-key-file FILEPATH
                           Output filepath of the verification key.
  --signing-key-file FILEPATH
                           Output filepath of the signing key.
</pre></div>
</div>
<p>We can make as many as is useful. Let’s make two.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis key-gen-utxo \
    --verification-key-file example/utxo-keys/utxo1.vkey \
    --signing-key-file example/utxo-keys/utxo1.skey
$ cardano-cli shelley genesis key-gen-utxo \
    --verification-key-file example/utxo-keys/utxo2.vkey \
    --signing-key-file example/utxo-keys/utxo2.skey
</pre></div>
</div>
</div>
<div class="section" id="the-genesis-file-itself">
<h3>The genesis file itself<a class="headerlink" href="#the-genesis-file-itself" title="Permalink to this headline">¶</a></h3>
<p>When we set up our template using the <code class="docutils literal notranslate"><span class="pre">create</span></code> command, it generated an
example genesis template for us in <code class="docutils literal notranslate"><span class="pre">example/genesis.spec.json</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;activeSlotsCoeff&quot;</span><span class="p">:</span> <span class="mf">5.0e-2</span><span class="p">,</span>
    <span class="s2">&quot;protocolParams&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;poolDecayRate&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;poolDeposit&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;protocolVersion&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;minor&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;major&quot;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">},</span>
        <span class="s2">&quot;decentralisationParam&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;maxTxSize&quot;</span><span class="p">:</span> <span class="mi">16384</span><span class="p">,</span>
        <span class="s2">&quot;minFeeA&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;maxBlockBodySize&quot;</span><span class="p">:</span> <span class="mi">65536</span><span class="p">,</span>
        <span class="s2">&quot;keyMinRefund&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;minFeeB&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;eMax&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;extraEntropy&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="s2">&quot;NeutralNonce&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;maxBlockHeaderSize&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="s2">&quot;keyDeposit&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;keyDecayRate&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;nOpt&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s2">&quot;rho&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;poolMinRefund&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;tau&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;a0&quot;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="s2">&quot;protocolMagicId&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
    <span class="s2">&quot;startTime&quot;</span><span class="p">:</span> <span class="s2">&quot;1970-01-01T00:00:00Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;genDelegs&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;updateQuorum&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;maxMajorPV&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;initialFunds&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;maxLovelaceSupply&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;networkMagic&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
    <span class="s2">&quot;epochLength&quot;</span><span class="p">:</span> <span class="mi">432000</span><span class="p">,</span>
    <span class="s2">&quot;staking&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;slotsPerKESPeriod&quot;</span><span class="p">:</span> <span class="mi">129600</span><span class="p">,</span>
    <span class="s2">&quot;slotLength&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;maxKESEvolutions&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
    <span class="s2">&quot;securityParam&quot;</span><span class="p">:</span> <span class="mi">2160</span>
<span class="p">}</span>
</pre></div>
</div>
<p>TODO: the generated file puts the fields in an unhelpful order.</p>
<p>We will mostly use these defaults for this demo. The meaning of all the ones
we do not edit here will be covered elsewhere.</p>
<p>When we regenerate the genesis file it will fill in the:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">genDelegs</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">initialFunds</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">startTime</span></code></li>
<li>and optionally it can override the <code class="docutils literal notranslate"><span class="pre">maxLovelaceSupply</span></code></li>
</ul>
<p>Let’s regenerate the genesis file (note, this command does not set an initial
Lovelace supply, that will be done later)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis create --genesis-dir example/
</pre></div>
</div>
<p>and then look at it and understand what the command has done</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat example/genesis.json
{
    &quot;activeSlotsCoeff&quot;: 5.0e-2,
    &quot;protocolParams&quot;: {
        &quot;poolDecayRate&quot;: 0,
        &quot;poolDeposit&quot;: 0,
        &quot;protocolVersion&quot;: {
            &quot;minor&quot;: 0,
            &quot;major&quot;: 0
        },
        &quot;decentralisationParam&quot;: 1,
        &quot;maxTxSize&quot;: 16384,
        &quot;minFeeA&quot;: 0,
        &quot;maxBlockBodySize&quot;: 65536,
        &quot;keyMinRefund&quot;: 0,
        &quot;minFeeB&quot;: 0,
        &quot;eMax&quot;: 0,
        &quot;extraEntropy&quot;: {
            &quot;tag&quot;: &quot;NeutralNonce&quot;
        },
        &quot;maxBlockHeaderSize&quot;: 1000,
        &quot;keyDeposit&quot;: 0,
        &quot;keyDecayRate&quot;: 0,
        &quot;nOpt&quot;: 100,
        &quot;rho&quot;: 0,
        &quot;poolMinRefund&quot;: 0,
        &quot;tau&quot;: 0,
        &quot;a0&quot;: 0
    },
    &quot;protocolMagicId&quot;: 42,
    &quot;startTime&quot;: &quot;2020-05-10T16:28:12.17999965Z&quot;,
    &quot;genDelegs&quot;: {
        &quot;a4d927a8e50c7a51e0f7d41a75057073cd2fc49bfc87a44891a8a9f80800cd8a&quot;:
          &quot;b2ee836b2b92fd3dd5e4228c943d8854e673c0510983956ce4f4ea7afcd9f761&quot;
    },
    &quot;updateQuorum&quot;: 5,
    &quot;maxMajorPV&quot;: 1,
    &quot;initialFunds&quot;: {
        &quot;820658207c3c942eaa39dd0aec74415312cf80dfc92b34fa1d0e1c2fd2499ee105219305&quot;: 0
        &quot;8206582076cb9794a896ee640dcb54bd932f3a0ca6012aa99cb7d767aec9f4d717c88d7b&quot;: 0
    },
    &quot;maxLovelaceSupply&quot;: 0,
    &quot;networkMagic&quot;: 42,
    &quot;epochLength&quot;: 432000,
    &quot;staking&quot;: null,
    &quot;slotsPerKESPeriod&quot;: 129600,
    &quot;slotLength&quot;: 1,
    &quot;maxKESEvolutions&quot;: 60,
    &quot;securityParam&quot;: 2160
}
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">GenDelegs</span></code> is the mapping from genesis keys to genesis delegates. The
representation in the JSON file is between key hashes.</p>
<p>So to understand where it got the key hashes from we can use a command to
get the key hash for each key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis key-hash
Usage: cardano-cli shelley genesis key-hash --verification-key-file FILEPATH
  Print the identifier (hash) of a public key

Available options:
  --verification-key-file FILEPATH
                           Input filepath of the verification key.
</pre></div>
</div>
<p>Let’s do that for our genesis key and genesis delegate key</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis key-hash \
    --verification-key-file example/genesis-keys/genesis1.vkey
  a4d927a8e50c7a51e0f7d41a75057073cd2fc49bfc87a44891a8a9f80800cd8a

$ cardano-cli shelley genesis key-hash \
    --verification-key-file example/delegate-keys/delegate1.vkey
  b2ee836b2b92fd3dd5e4228c943d8854e673c0510983956ce4f4ea7afcd9f761
</pre></div>
</div>
<p>So now we can see where the hashes from the <code class="docutils literal notranslate"><span class="pre">genDelegs</span></code> came from</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="s2">&quot;genDelegs&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;a4d927a8e50c7a51e0f7d41a75057073cd2fc49bfc87a44891a8a9f80800cd8a&quot;</span><span class="p">:</span>
      <span class="s2">&quot;b2ee836b2b92fd3dd5e4228c943d8854e673c0510983956ce4f4ea7afcd9f761&quot;</span>
  <span class="p">},</span>
</pre></div>
</div>
<p>Next it’s a similar deal with the <code class="docutils literal notranslate"><span class="pre">initialFunds</span></code>. This is a mapping from the
initial <em>addresses</em> to the initial values at those address. So we need a
command to get the address corresponding to an initial UTxO verification key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis initial-addr
Usage: cardano-cli shelley genesis initial-addr --verification-key-file FILEPATH
  Get the address for an initial UTxO based on the verification key

Available options:
  --verification-key-file FILEPATH
                           Input filepath of the verification key.
</pre></div>
</div>
<p>So let’s do that for the UTxO key</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis initial-addr \
    --verification-key-file example/utxo-keys/utxo1.vkey
  820658207c3c942eaa39dd0aec74415312cf80dfc92b34fa1d0e1c2fd2499ee105219305
</pre></div>
</div>
<p>And if we compare this with the <code class="docutils literal notranslate"><span class="pre">initialFunds</span></code> from the generated file we see</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="s2">&quot;initialFunds&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;820658207c3c942eaa39dd0aec74415312cf80dfc92b34fa1d0e1c2fd2499ee105219305&quot;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="s2">&quot;8206582076cb9794a896ee640dcb54bd932f3a0ca6012aa99cb7d767aec9f4d717c88d7b&quot;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>This means we’ll start with 0 lovelace in a special genesis UTxO at that
address.</p>
<p>Ok, so zero lovelace is not that useful. We can however edit the
<code class="docutils literal notranslate"><span class="pre">genesis.spec.json</span></code> and set the <code class="docutils literal notranslate"><span class="pre">maxLovelaceSupply</span></code> there, or we specify the
initial supply when we re-generate the genesis file. Either way, it will be
split equally between all the utxo keys.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis create \
    --genesis-dir example/ \
    --supply 1000000
</pre></div>
</div>
<p>Yes <a class="reference external" href="https://www.youtube.com/watch?v=l91ISfcuzDw">ONE MILLION LOVELACE</a>.</p>
<p>If we look again at the generated genesis file now we’ll see</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="s2">&quot;initialFunds&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;820658207c3c942eaa39dd0aec74415312cf80dfc92b34fa1d0e1c2fd2499ee105219305&quot;</span><span class="p">:</span> <span class="mi">500000</span>
    <span class="s2">&quot;8206582076cb9794a896ee640dcb54bd932f3a0ca6012aa99cb7d767aec9f4d717c88d7b&quot;</span><span class="p">:</span> <span class="mi">500000</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>So we see the amount split between our two initial addresses.</p>
<p>You will also see that the <code class="docutils literal notranslate"><span class="pre">maxLovelaceSupply</span></code> is set to this same supply. If
you edit this manually note that it has to be at least as big as the sum total
from our <code class="docutils literal notranslate"><span class="pre">initialFunds</span></code>, but it can be bigger to allow for monetary expansion
later for stake rewards.</p>
<p>Finally there is the <code class="docutils literal notranslate"><span class="pre">startTime</span></code>, which is the agreed time of slot zero.
By default the <code class="docutils literal notranslate"><span class="pre">create</span></code> command filled this in to be 30s into the
future, but you can also specify this manually with <code class="docutils literal notranslate"><span class="pre">--start-time</span> <span class="pre">UTC_TIME</span></code>
or edit it manually afterwards. It needs to be set to a time in the near future
or near past. It cannot be too far in the past otherwise the system would start
having missed a very large number of slots.</p>
</div>
</div>
<div class="section" id="making-a-genesis-file-semi-automagically">
<h2>Making a genesis file semi-automagically<a class="headerlink" href="#making-a-genesis-file-semi-automagically" title="Permalink to this headline">¶</a></h2>
<p>If you jumped straight in here, skipping the manual method, do go back and
review that section covers the concepts about what these keys are all for.</p>
<p>Also remember: <strong>when doing it for real you cannot use the automagic method.</strong>
It is not secure to because it makes all the keys in one place.
When doing it for real the people involved have to follow the manual method
where keys are generated separately on secure offline machines.</p>
<p>But for demos it is fine</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis
Usage: cardano-cli shelley genesis COMMAND
  Shelley genesis block commands

Available commands:
  key-gen-genesis          Create a Shelley genesis key pair
  key-gen-delegate         Create a Shelley genesis delegate key pair
  key-gen-utxo             Create a Shelley genesis UTxO key pair
  key-hash                 Print the identifier (hash) of a public key
  get-ver-key              Derive the verification key from a signing key
  initial-txin             Get the TxIn for an initial UTxO based on the
                           verification key
  create                   Create a Shelley genesis file from a genesis template
                           and genesis/delegation/spending keys.
</pre></div>
</div>
<p>The automagic method uses the last one, <code class="docutils literal notranslate"><span class="pre">create</span></code>, and all the others
are for the manual method.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis create
Usage: cardano-cli shelley genesis create --genesis-dir DIR
                                          [--gen-genesis-keys INT]
                                          [--gen-utxo-keys INT]
                                          [--start-time UTC_TIME]
                                          [--supply LOVELACE]
  Create a Shelley genesis file from a genesis template and
  genesis/delegation/spending keys.

Available options:
  --genesis-dir DIR        The genesis directory containing the genesis template
                           and required genesis/delegation/spending keys.
  --gen-genesis-keys INT   The number of genesis keys to make [default is 0].
  --gen-utxo-keys INT      The number of UTxO keys to make [default is 0].
  --start-time UTC_TIME    The genesis start time in YYYY-MM-DDThh:mm:ssZ
                           format. If unspecified, will be the current time +30
                           seconds.
  --supply LOVELACE        The initial coin supply in Lovelace which will be
                           evenly distributed across initial stake holders.
</pre></div>
</div>
<p>This command will generate a genesis file. It can also generate all the keys,
or it can pick up keys you created manually.</p>
<p>It follows this file layout convention:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">${genesisdir}/genesis.json</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">${genesisdir}/genesis.spec.json</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">${genesisdir}/genesis-keys/genesis${N}.{vkey,skey}</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">${genesisdir}/delegate-keys/delegate${N}.{vkey,skey}</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">${genesisdir}/delegate-keys/delegate-opcert${N}.counter</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">${genesisdir}/utxo-keys/utxo${N}.{vkey,skey}</span></code></li>
</ul>
<p>By default it will not create any keys for you, and will pick up any that you
have created manually following the file layout convention.</p>
<p>You can set up the directory layout with a default genesis spec file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis create --genesis-dir example/
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">create</span></code> command can also create all the necessary keys for you.
The optional <code class="docutils literal notranslate"><span class="pre">--gen-genesis-keys</span></code> and <code class="docutils literal notranslate"><span class="pre">--gen-utxo-keys</span></code> flags can be used to
specify the number of keys of each kind to generate.</p>
<p>We still need a genesis spec to start from. Here’s the default genesis spec
file <code class="docutils literal notranslate"><span class="pre">example/genesis.spec.json</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;activeSlotsCoeff&quot;</span><span class="p">:</span> <span class="mf">5.0e-2</span><span class="p">,</span>
    <span class="s2">&quot;protocolParams&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;poolDecayRate&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;poolDeposit&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;protocolVersion&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;minor&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;major&quot;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">},</span>
        <span class="s2">&quot;decentralisationParam&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;maxTxSize&quot;</span><span class="p">:</span> <span class="mi">16384</span><span class="p">,</span>
        <span class="s2">&quot;minFeeA&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;maxBlockBodySize&quot;</span><span class="p">:</span> <span class="mi">65536</span><span class="p">,</span>
        <span class="s2">&quot;keyMinRefund&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;minFeeB&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;eMax&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;extraEntropy&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="s2">&quot;NeutralNonce&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;maxBlockHeaderSize&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="s2">&quot;keyDeposit&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;keyDecayRate&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;nOpt&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s2">&quot;rho&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;poolMinRefund&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;tau&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;a0&quot;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="s2">&quot;protocolMagicId&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
    <span class="s2">&quot;startTime&quot;</span><span class="p">:</span> <span class="s2">&quot;1970-01-01T00:00:00Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;genDelegs&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;updateQuorum&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;maxMajorPV&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;initialFunds&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;maxLovelaceSupply&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;networkMagic&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
    <span class="s2">&quot;epochLength&quot;</span><span class="p">:</span> <span class="mi">432000</span><span class="p">,</span>
    <span class="s2">&quot;staking&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;slotsPerKESPeriod&quot;</span><span class="p">:</span> <span class="mi">129600</span><span class="p">,</span>
    <span class="s2">&quot;slotLength&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;maxKESEvolutions&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
    <span class="s2">&quot;securityParam&quot;</span><span class="p">:</span> <span class="mi">2160</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">create</span></code> will read the <code class="docutils literal notranslate"><span class="pre">genesis.spec.json</span></code> and produce the
<code class="docutils literal notranslate"><span class="pre">genesis.json</span></code> by filling in the:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">genDelegs</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">initialFunds</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">startTime</span></code></li>
<li>and optionally it can override the <code class="docutils literal notranslate"><span class="pre">maxLovelaceSupply</span></code></li>
</ul>
<p>Everything else we have to fill in manually, either in the template or
afterwards.</p>
<p>So let’s try it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis create \
    --genesis-dir example/ \
    --supply 1000000000 \
    --gen-genesis-keys 2 \
    --gen-utxo-keys 2
</pre></div>
</div>
<p>We’re going for more zeros on our money supply this time, after all
<a class="reference external" href="https://www.youtube.com/watch?v=xyyqoHCkw9I">why make trillions when we could make billions?</a></p>
<p>Let’s have a look at the result</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat example/genesis.json
{
    &quot;decentralisationParam&quot;: 1,
    &quot;activeSlotsCoeff&quot;: 5.0e-2,
    &quot;protocolMagicId&quot;: 42,
    &quot;startTime&quot;: &quot;2020-05-07T01:46:02.884394538Z&quot;,
    &quot;genDelegs&quot;: {
        &quot;40a5d0f1db7ec1bcf92758f1909677576b4edf7164c94602bee0f7848495c615&quot;:
          &quot;6e8f60c82449be3d6c17415d784881476d81ed99d88108526e5a32c8d087bdc8&quot;,
        &quot;60262fd1a9c700730c93a8cc855d840f8a9795d956e8ee1f6980657efa172fbb&quot;:
          &quot;6e8f60c82449be3d6c17415d784881476d81ed99d88108526e5a32c8d087bdc8&quot;
    },
    &quot;updateQuorum&quot;: 5,
    &quot;maxHeaderSize&quot;: 1400,
    &quot;maxMajorPV&quot;: 1000,
    &quot;maxBodySize&quot;: 16384,
    &quot;maxLovelaceSupply&quot;: 1000000000,
    &quot;initialFunds&quot;: {
        &quot;8206582080edb9890519e08847aff26f55a076a439b9835baa7113d04ad1ed9b2ea55817&quot;: 500000000,
        &quot;8206582076cb9794a896ee640dcb54bd932f3a0ca6012aa99cb7d767aec9f4d717c88d7b&quot;: 500000000
    },
    &quot;networkMagic&quot;: 42,
    &quot;epochLength&quot;: 21600,
    &quot;slotLength&quot;: 1,
    &quot;slotsPerKESPeriod&quot;: 86400,
    &quot;maxKESEvolutions&quot;: 90,
    &quot;securityParam&quot;: 2160,
    &quot;protocolParams&quot;: {
           &quot;a0&quot;: 0,
           &quot;decentralisationParam&quot;: 0.99,
           &quot;eMax&quot;: 0,
           &quot;extraEntropy&quot;: {
               &quot;tag&quot;: &quot;NeutralNonce&quot;
           },
           &quot;keyDecayRate&quot;: 0,
           &quot;keyDeposit&quot;: 0,
           &quot;keyMinRefund&quot;: 0,
           &quot;maxBlockBodySize&quot;: 2097152,
           &quot;maxBlockHeaderSize&quot;: 8192,
           &quot;maxTxSize&quot;: 2048,
           &quot;minFeeA&quot;: 0,
           &quot;minFeeB&quot;: 0,
           &quot;nOpt&quot;: 100,
           &quot;poolDecayRate&quot;: 0,
           &quot;poolDeposit&quot;: 0,
           &quot;poolMinRefund&quot;: 0,
           &quot;protocolVersion&quot;: {
               &quot;major&quot;: 0,
               &quot;minor&quot;: 0
           },
           &quot;rho&quot;: 0,
           &quot;tau&quot;: 0
       }
}
</pre></div>
</div>
<p>And the files it made</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls example/*/
example/delegate-keys/:
delegate1.skey     delegate-opcert1.counter
delegate1.vkey     delegate-opcert2.counter
delegate2.skey
delegate2.vkey

example/genesis-keys/:
genesis1.skey  genesis2.skey
genesis1.vkey  genesis2.vkey

example/utxo-keys/:
utxo1.skey  utxo2.skey
utxo1.vkey  utxo2.vkey
</pre></div>
</div>
<p>You’ll notice that the automagic method has divided the total supply amongst
the initial UTxO keys, but you can still edit this file manually to adjust that
if you want.</p>
</div>
<div class="section" id="node-operational-keys-and-certificates">
<h2>Node operational keys and certificates<a class="headerlink" href="#node-operational-keys-and-certificates" title="Permalink to this headline">¶</a></h2>
<p>Armed just with the genesis file we could now start a node, however it would
raise difficult philosophical questions about the nature of a blockchain with
no blocks. To avoid such questions, let’s aim to have some nodes that can create
blocks. Of course this means everyone’s favourite: more keys.</p>
<p>Shelley uses a “hot key / cold key” scheme for block producing nodes:</p>
<ul class="simple">
<li>the cold key is intended to be kept securely offline (hence “cold”),</li>
<li>while the hot key is kept on the node itself and used to sign block headers.</li>
</ul>
<p>Rather than cold and hot, we typically refer to the operator’s offline key
(cold) and their operational key (hot).</p>
<p>The basic idea of such a scheme is that if the operational key is compromised
then a new one can be issued and the old one invalidated. This involves
establishing the link between the operator’s offline key and their operational
key. This is done by means of a certificate. The certificate identifies the
current operational key, and is signed by the offline key. The certificate also
contains an issue counter number so that all other nodes can see when a new
certificate is being used and old certificates should be considered invalid.</p>
<p>The act of “issuing” a new certificate simply means the act of signing a new
certificate using the offline key.</p>
<p>To make things even more fun, Shelley uses <em>two</em> operational keys:</p>
<ul class="simple">
<li>A KES key, using magic crypto;</li>
<li>A VRF key, using even more magic crypto.</li>
</ul>
<p>They are both used in block headers. The KES key is used to prove that the
node is who it says it is, just like a normal signature. The VRF key is used
to prove that the node has the right to create a block in this slot.</p>
<p>The use of a VRF key is special to Ouroboros Praos. In a “normal” proof-of-stake
blockchain (like Ouroboros Classic or BFT) one simply knows who has the right to
make the block in each slot, because we <em>know</em> what the slot leader schedule is:
that is the slot leader schedule is public. So in that case you only have to
prove you are who you say you are, and everyone can check that the slot leader
schedule says if you’re the slot leader or not. Ouroboros Praos has a <em>private</em>
slot leader schedule. This means that nobody knows in advance who is going to
be the slot leader, but once someone is, they can prove to everyone else that
they are. And that is what the VRF key is for: proving that.</p>
<p>KES stands for <strong>K</strong>ey <strong>E</strong>volving <strong>S</strong>ignature. It is like a normal
signature scheme, but with the “forward-security” property. The signing key is
“evolved” after a number of slots (e.g. the number of slots equivalent to 24
hours) to give a new signing key, and the old key is forgotten. It means that
if someone breaks into a server running a node, while they can steal the
current signing key, they should not be able to recover the signing keys from
earlier periods. This means that an attacker cannot sign blocks for this node
for the past, only for the current and future. This helps to prevent the
creation of large false alternative histories of the blockchain.</p>
<p>As is normal security practice, hot or operational keys should be cycled after
a while, and new operational keys issued. There is also a technical limitation
that KES signing keys can only be evolved a finite number of times. The larger
that choice of the maximum number of evolutions, the larger the signatures
become. The signatures are included in block headers, and for good performance
we want to keep block headers small. In Shelley, the KES keys will need to
be reissued before 90 days, but they can always be reissued earlier.</p>
<p>So in order to run a Shelley node we will need to:</p>
<ul class="simple">
<li>generate an operator’s offline key;</li>
<li>generate a KES operational key;</li>
<li>generate a VRF operational key; and</li>
<li>issue an operational certificate</li>
</ul>
<p>The latter three are needed by the node itself, and issuing the operational
certificate needs the operator’s offline key.</p>
<p>Now if you followed the previous section on constructing a genesis file, then
you have already generated operator offline keys: the genesis delegates are
exactly that. The other operator offline keys are stake pool keys. For most
purposes the genesis delegate and stake pool operator offline keys are the same:
both get used to issue operational certs.</p>
<p>We can create stake pool operator keys using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley node key-gen
Usage: cardano-cli shelley node key-gen --verification-key-file FILEPATH
                                        --signing-key-file FILEPATH
                                        --operational-certificate-issue-counter FILE
  Create a key pair for a node operator&#39;s offline key and a new certificate
  issue counter

Available options:
  --verification-key-file FILEPATH
                           Output filepath of the verification key.
  --signing-key-file FILEPATH
                           Output filepath of the signing key.
  --operational-certificate-issue-counter FILE
                           The file with the issue counter for the operational
                           certificate.
</pre></div>
</div>
<p>For now we will ignore stake pools however since we need to get the system
bootstrapped with the BFT overlay.</p>
<div class="section" id="kes-keys">
<h3>KES Keys<a class="headerlink" href="#kes-keys" title="Permalink to this headline">¶</a></h3>
<p>There’s a command to generate new KES keys</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cardano</span><span class="o">-</span><span class="n">cli</span> <span class="n">shelley</span> <span class="n">node</span> <span class="n">key</span><span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">KES</span>
<span class="n">Usage</span><span class="p">:</span> <span class="n">cardano</span><span class="o">-</span><span class="n">cli</span> <span class="n">shelley</span> <span class="n">node</span> <span class="n">key</span><span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">KES</span> <span class="o">--</span><span class="n">verification</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">file</span> <span class="n">FILEPATH</span>
                                            <span class="o">--</span><span class="n">signing</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">file</span> <span class="n">FILEPATH</span>
  <span class="n">Create</span> <span class="n">a</span> <span class="n">key</span> <span class="n">pair</span> <span class="k">for</span> <span class="n">a</span> <span class="n">node</span> <span class="n">KES</span> <span class="n">operational</span> <span class="n">key</span>

<span class="n">Available</span> <span class="n">options</span><span class="p">:</span>
  <span class="o">--</span><span class="n">verification</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">file</span> <span class="n">FILEPATH</span>
                           <span class="n">Output</span> <span class="n">filepath</span> <span class="n">of</span> <span class="n">the</span> <span class="n">verification</span> <span class="n">key</span><span class="o">.</span>
  <span class="o">--</span><span class="n">signing</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">file</span> <span class="n">FILEPATH</span>
                           <span class="n">Output</span> <span class="n">filepath</span> <span class="n">of</span> <span class="n">the</span> <span class="n">signing</span> <span class="n">key</span><span class="o">.</span>
</pre></div>
</div>
<p>So let’s go ahead and create a KES key for our first two nodes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir example/{node1,node2}

$ cardano-cli shelley node key-gen-KES \
    --verification-key-file example/node1/kes.vkey \
    --signing-key-file example/node1/kes.skey

$ cardano-cli shelley node key-gen-KES \
    --verification-key-file example/node2/kes.vkey \
    --signing-key-file example/node2/kes.skey
</pre></div>
</div>
<p>If you look at these files, you’ll see that KES signing keys are quite chunky,
especially compared to our normal ed25519 keys.</p>
</div>
<div class="section" id="vrf-keys">
<h3>VRF Keys<a class="headerlink" href="#vrf-keys" title="Permalink to this headline">¶</a></h3>
<p>And there’s a command to generate new VRF keys</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley node key-gen-VRF
Usage: cardano-cli shelley node key-gen-VRF --verification-key-file FILEPATH
                                            --signing-key-file FILEPATH
  Create a key pair for a node VRF operational key

Available options:
  --verification-key-file FILEPATH
                           Output filepath of the verification key.
  --signing-key-file FILEPATH
                           Output filepath of the signing key.
</pre></div>
</div>
<p>So let’s do that too</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley node key-gen-VRF \
    --verification-key-file example/node1/vrf.vkey \
    --signing-key-file example/node1/vrf.skey

$ cardano-cli shelley node key-gen-VRF \
    --verification-key-file example/node2/vrf.vkey \
    --signing-key-file example/node2/vrf.skey
</pre></div>
</div>
</div>
<div class="section" id="issuing-an-operational-certificate">
<h3>Issuing an operational certificate<a class="headerlink" href="#issuing-an-operational-certificate" title="Permalink to this headline">¶</a></h3>
<p>Now we get to the stage of wanting to issue an operational certificate.</p>
<p>When doing this for real, the operator’s offline key should of course be
offline, so we would issue the certificate on the offline machine with
the offline key, and copy the resulting certificate to the operational machine.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley node issue-op-cert
Usage: cardano-cli shelley node issue-op-cert --hot-kes-verification-key-file FILEPATH
                                              --cold-signing-key-file FILEPATH
                                              --operational-certificate-issue-counter FILE
                                              --kes-period NATURAL
                                              --out-file FILE
  Issue a node operational certificate

Available options:
  --hot-kes-verification-key-file FILEPATH
                           Filepath of the hot KES verification key.
  --cold-signing-key-file FILEPATH
                           Filepath of the cold signing key.
  --operational-certificate-issue-counter FILE
                           The file with the issue counter for the operational
                           certificate.
  --kes-period NATURAL     The start of the KES key validity period.
  --out-file FILE          The output file.
</pre></div>
</div>
<p>There’s a few things here to understand.</p>
<p>As discussed above, a certificate identifies an operational KES key that we
will be using to sign block headers, so we need its verification key. It is
signed by the operator’s offline key so we need that signing key.</p>
<p>As mentioned, certificates have an issue counter number that is used to
inform other nodes that older certificates are now invalid. This certificate
issue counter must be kept with the operator’s offline key. You’ll notice they
got created when we created the genesis delegate keys, or if you create a new
stake pool key.</p>
<p>Finally we have a confusing flag for the KES period. Each operational
certificate specifies when the certificate is valid from. This is like a date
but is specified in terms of KES periods, which is some number of slots long.
Frankly, this needs improving in the CLI tools and/or documentation. For now
we are creating a system from scratch so we can start with period 0.</p>
<p>So let’s go ahead and issue ourselves an operational certificate. We will sign
using use the genesis delegate keys we created earlier.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley node issue-op-cert \
    --hot-kes-verification-key-file example/node1/kes.vkey \
    --cold-signing-key-file example/delegate-keys/delegate1.skey \
    --operational-certificate-issue-counter example/delegate-keys/delegate-opcert1.counter \
    --kes-period 0 \
    --out-file example/node1/cert

$ cardano-cli shelley node issue-op-cert \
    --hot-kes-verification-key-file example/node2/kes.vkey \
    --cold-signing-key-file example/delegate-keys/delegate2.skey \
    --operational-certificate-issue-counter example/delegate-keys/delegate-opcert2.counter \
    --kes-period 0 \
    --out-file example/node2/cert
</pre></div>
</div>
</div>
</div>
<div class="section" id="starting-a-node">
<h2>Starting a node<a class="headerlink" href="#starting-a-node" title="Permalink to this headline">¶</a></h2>
<p>Now that we have generated our <code class="docutils literal notranslate"><span class="pre">genesis.json</span></code>, KES and VRF operational keys and
issued ourselves operational certificates, we are close to being able to run
our nodes.</p>
<p>The last things we need are node configuration and topology files.</p>
<p>For the configuration file, we can start with the default
<a class="reference external" href="https://github.com/input-output-hk/cardano-node/blob/master/configuration/defaults/byron-mainnet/configuration.yaml">Byron mainnet configuration</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cp cardano-node/configuration/defaults/byron-mainnet/configuration.yaml \
     example/
</pre></div>
</div>
<p>and make a couple tweaks</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sed -i &#39;s/Protocol: RealPBFT/Protocol: TPraos/&#39; example/configuration.yaml
$ sed -i &#39;s/minSeverity: Info/minSeverity: Debug/&#39; example/configuration.yaml
</pre></div>
</div>
<p>We will share this <code class="docutils literal notranslate"><span class="pre">configuration.yaml</span></code> file between both nodes we run.</p>
<p>The topology files tell nodes which other nodes to talk to. We will need one
for each node we run. For this demo we will be running two nodes on the same
machine, one on port 3001 and the other on 3002. We will configure them to
talk to each other.</p>
<p>So create the following two files as <code class="docutils literal notranslate"><span class="pre">example/node1/topology.json</span></code> and
<code class="docutils literal notranslate"><span class="pre">example/node2/topology.json</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;Producers&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">3002</span><span class="p">,</span>
      <span class="s2">&quot;valency&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;Producers&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">3001</span><span class="p">,</span>
      <span class="s2">&quot;valency&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>So node1 will listen on port 3001 and contact node2 on port 3002, and the other
way around for node2.</p>
<p>Now we are ready to run our two nodes. With the way we have set them up should
both be block-producing nodes that take part in the BFT overlay schedule.</p>
<p>One final tweak before we start: it has probably been some time since we
generated the <code class="docutils literal notranslate"><span class="pre">genesis.json</span></code>, so the start time is probably now some time in
the past. It is a bit nicer if we set the start time to be shortly in the
future and then start up our nodes. That way they will all wait for the start
time and then make blocks from the beginning.</p>
<p>So let’s just re-generate our <code class="docutils literal notranslate"><span class="pre">genesis.json</span></code> which will set the start time to
be 30 seconds into the future, and then we can start our nodes. This assumes
you did not do any manual tweaking of the generated <code class="docutils literal notranslate"><span class="pre">genesis.json</span></code>, as it will
be overwritten.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis create --genesis-dir example/
</pre></div>
</div>
<p>So, now in two separate terminal windows we can launch our nodes. Node 1:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-node run \
    --config example/configuration.yaml \
    --topology example/node1/topology.json \
    --database-path example/node1/db \
    --socket-path example/node1/node.sock \
    --shelley-kes-key example/node1/kes.skey \
    --shelley-vrf-key example/node1/vrf.skey \
    --shelley-operational-certificate example/node1/cert \
    --port 3001
</pre></div>
</div>
<p>And node 2:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-node run \
    --config example/configuration.yaml \
    --topology example/node2/topology.json \
    --database-path example/node2/db \
    --socket-path example/node2/node.sock \
    --shelley-kes-key example/node2/kes.skey \
    --shelley-vrf-key example/node2/vrf.skey \
    --shelley-operational-certificate example/node2/cert \
    --port 3002
</pre></div>
</div>
<p>The default configuration will log everything to stdout, and we turned the
log level up so we’ll see even debug messages, so it will be pretty voluminous.</p>
<p>If you did manage to start the nodes before the start time, you’ll see them
waiting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">localhost</span><span class="p">:</span><span class="n">cardano</span><span class="o">.</span><span class="n">node</span><span class="p">:</span><span class="n">Debug</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="p">[</span><span class="mi">2020</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">10</span> <span class="mi">21</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mf">40.77</span> <span class="n">UTC</span><span class="p">]</span>
  <span class="n">Waiting</span> <span class="mf">23.921899468</span><span class="n">s</span> <span class="n">until</span> <span class="n">genesis</span> <span class="n">start</span> <span class="n">time</span> <span class="n">at</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">10</span> <span class="mi">21</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mf">04.701779756</span> <span class="n">UTC</span>
</pre></div>
</div>
<p>After that, you should see the nodes start to alternately create blocks and
adopt each others blocks. Remember that we have configured slots to be 1 second
long but only 1 in 20 slots will have a block in it.</p>
</div>
<div class="section" id="querying-the-node">
<h2>Querying the node<a class="headerlink" href="#querying-the-node" title="Permalink to this headline">¶</a></h2>
<p>Now that our nodes are running, let’s poke them and see if they’re doing what
we expect. We’ll need a third terminal.</p>
<div class="section" id="querying-protocol-parameters">
<h3>Querying protocol parameters<a class="headerlink" href="#querying-protocol-parameters" title="Permalink to this headline">¶</a></h3>
<p>We’ll start with querying the node to see the current set of protocol parameters.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley query protocol-parameters
Usage: cardano-cli shelley query protocol-parameters (--mainnet |
                                                       --testnet-magic INT)
                                                     [--out-file FILE]
  Get the node&#39;s current protocol parameters

Available options:
  --mainnet                Use the mainnet magic id.
  --testnet-magic INT      Specify a testnet magic id.
  --out-file FILE          Optional output file. Default is to write to stdout.
</pre></div>
</div>
<p>The only surprising extra flag is the “network magic”. This is the
<code class="docutils literal notranslate"><span class="pre">networkMagic</span></code> from the <code class="docutils literal notranslate"><span class="pre">genesis.json</span></code>. In the default we generated, that was
given as 42. The network “magic” number is used as a simple sanity check (not a
security measure of course) when nodes connect to each other, to stop nodes
accidentally connecting to nodes running different blockchains, e.g. testnet
vs mainnet. We have the same sanity check when we connect to the local node.
So we have to specify <code class="docutils literal notranslate"><span class="pre">--testnet-magic</span> <span class="pre">42</span></code>, otherwise it defaults to mainnet
and then the handshake would fail.</p>
<p>This command of course connects to a local node. The socket for the local
node is set via an environment variable <code class="docutils literal notranslate"><span class="pre">CARDANO_NODE_SOCKET_PATH</span></code>. Typically one
only runs one node on a machine, and so it would make sense to set this for
the whole terminal session:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export CARDANO_NODE_SOCKET_PATH=$PWD/example/node1/node.sock
</pre></div>
</div>
<p>In this demo we are running two nodes however so we’ll specify the env var each
time in the command.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ CARDANO_NODE_SOCKET_PATH=example/node1/node.sock \
    cardano-cli shelley query protocol-parameters \
    --testnet-magic 42
{
    &quot;poolDecayRate&quot;: 0,
    &quot;poolDeposit&quot;: 0,
    &quot;protocolVersion&quot;: {
        &quot;minor&quot;: 0,
        &quot;major&quot;: 0
    },
    &quot;decentralisationParam&quot;: 1,
    &quot;maxTxSize&quot;: 16384,
    &quot;minFeeA&quot;: 0,
    &quot;maxBlockBodySize&quot;: 65536,
    &quot;keyMinRefund&quot;: 0,
    &quot;minFeeB&quot;: 0,
    &quot;eMax&quot;: 0,
    &quot;extraEntropy&quot;: {
        &quot;tag&quot;: &quot;NeutralNonce&quot;
    },
    &quot;maxBlockHeaderSize&quot;: 1000,
    &quot;keyDeposit&quot;: 0,
    &quot;keyDecayRate&quot;: 0,
    &quot;nOpt&quot;: 100,
    &quot;rho&quot;: 0,
    &quot;poolMinRefund&quot;: 0,
    &quot;tau&quot;: 0,
    &quot;a0&quot;: 0
}
</pre></div>
</div>
<p>As we can see, it spits out the same set of protocol parameters from the
<code class="docutils literal notranslate"><span class="pre">genesis.json</span></code> file we started with.</p>
</div>
<div class="section" id="querying-the-utxo">
<h3>Querying the UTxO<a class="headerlink" href="#querying-the-utxo" title="Permalink to this headline">¶</a></h3>
<p>For our next trick we will inspect the UTxO. Of course we have not done
any transactions yet so we expect just the initial UTxO as specified in
the <code class="docutils literal notranslate"><span class="pre">genesis.json</span></code>.</p>
<p>There is a command to query the UTxO and return all the UTxOs at a given
address.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley query filtered-utxo
Usage: cardano-cli shelley query filtered-utxo --address ADDRESS
                                               (--mainnet | --testnet-magic INT)
                                               [--out-file FILE]
  Get the node&#39;s current UTxO filtered by address

Available options:
  --address ADDRESS        A hex-encoded Cardano address.
  --mainnet                Use the mainnet magic id.
  --testnet-magic INT      Specify a testnet magic id.
  --out-file FILE          Optional output file. Default is to write to stdout.
</pre></div>
</div>
<p>So what address do we need? The one(s) from the <code class="docutils literal notranslate"><span class="pre">initialFunds</span></code> in the
<code class="docutils literal notranslate"><span class="pre">genesis.json</span></code> of course. So let’s try it. Obviously you will have to adjust
this command to use the right address(es) from your <code class="docutils literal notranslate"><span class="pre">genesis.json</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ CARDANO_NODE_SOCKET_PATH=example/node1/node.sock \
    cardano-cli shelley query filtered-utxo \
    --testnet-magic 42 \
    --address 8206582080edb9890519e08847aff26f55a076a439b9835baa7113d04ad1ed9b2ea55817

                           TxHash                                 TxIx        Lovelace
----------------------------------------------------------------------------------------
80edb9890519e08847aff26f55a076a439b9835baa7113d04ad1ed9b2ea55817     0         500000000
</pre></div>
</div>
<p>So this tells us that there is exactly one UTxO entry at that address, with one
unspent output (output zero).</p>
<p>The next step will be to spend this.</p>
</div>
</div>
<div class="section" id="submitting-a-genesis-initial-utxo-transaction">
<h2>Submitting a Genesis initial UTxO transaction<a class="headerlink" href="#submitting-a-genesis-initial-utxo-transaction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="preparing-the-ingredients">
<h3>Preparing the ingredients<a class="headerlink" href="#preparing-the-ingredients" title="Permalink to this headline">¶</a></h3>
<p>There are a few things we need to make our first transaction:</p>
<ul class="simple">
<li>A UTxO to spend</li>
<li>The signing key for the UTxO we’re spending</li>
<li>An address to spend to</li>
</ul>
<p>Spending the Genesis initial UTxOs is a little special because of the way the
initial UTxO is constructed. But we have seen above that we can find the UTxOs
that we want to spend.</p>
<p>We also have the signing key from when we constructed the genesis, e.g. in
<code class="docutils literal notranslate"><span class="pre">example/utxo-keys/utxo1.skey</span></code>.</p>
<p>For an output address, we will need to make one.</p>
</div>
<div class="section" id="finding-the-initial-utxo-txin">
<h3>Finding the initial UTxO TxIn<a class="headerlink" href="#finding-the-initial-utxo-txin" title="Permalink to this headline">¶</a></h3>
<p>To avoid confusion about which UTxO goes with which key, we have this handy
command</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis initial-txin
Usage: cardano-cli shelley genesis initial-txin --verification-key-file FILEPATH
  Get the TxIn for an initial UTxO based on the verification key

Available options:
  --verification-key-file FILEPATH
                           Input filepath of the verification key.
</pre></div>
</div>
<p>Which we can use with our <code class="docutils literal notranslate"><span class="pre">example/utxo-keys/utxo1.vkey</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley genesis initial-txin \
    --verification-key-file example/utxo-keys/utxo1.vkey
80edb9890519e08847aff26f55a076a439b9835baa7113d04ad1ed9b2ea55817#0
</pre></div>
</div>
<p>Note the TxIn syntax of “long hash # ix”, here with index 0.</p>
</div>
<div class="section" id="making-new-keys-and-addresses">
<h3>Making new keys and addresses<a class="headerlink" href="#making-new-keys-and-addresses" title="Permalink to this headline">¶</a></h3>
<p>We will make a key pair and then build an address from that. Let’s start with
the keypair.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley address key-gen
Usage: cardano-cli shelley address key-gen --verification-key-file FILEPATH
                                           --signing-key-file FILEPATH
  Create a single address key pair

Available options:
  --verification-key-file FILEPATH
                           Input filepath of the verification key.
  --signing-key-file FILEPATH
                           Input filepath of the signing key.
</pre></div>
</div>
<p>So let’s do it</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley address key-gen \
    --verification-key-file example/addr1.vkey \
    --signing-key-file example/addr1.skey
</pre></div>
</div>
<p>We can now build an address from our key.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley address build
Usage: cardano-cli shelley address build --payment-verification-key-file FILEPATH
                                         [--staking-verification-key-file FILEPATH]
  Build a Shelley payment addres, with optional delegation to a stake address.

Available options:
  --payment-verification-key-file FILEPATH
                           Filepath of the payment verification key.
  --staking-verification-key-file FILEPATH
                           Filepath of the staking verification key.
</pre></div>
</div>
<p>This command can also build payment addresses that are associated with stake
addresses, and thus have the ability to delegate the stake rights.</p>
<p>For now however let’s see our boring address with no stake rights:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley address build \
    --payment-verification-key-file example/addr1.vkey
82065820cd44104b49b97dae659dabf040cc7d588ea28e52addffc66fd126bb23be87451
</pre></div>
</div>
<p>The CLI uses a low-tech hex encoding for addresses, rather than fancy bech32.</p>
</div>
<div class="section" id="building-an-unsigned-transaction-body">
<h3>Building an unsigned transaction body<a class="headerlink" href="#building-an-unsigned-transaction-body" title="Permalink to this headline">¶</a></h3>
<p>We will be using the low level <code class="docutils literal notranslate"><span class="pre">build-raw</span></code> command because a more convenient
command is not available yet, and because for spending a Genesis UTxO we have
to use the low level command to select the exact UTxO to spend.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley transaction build-raw
Usage: cardano-cli shelley transaction build-raw --tx-in TX_IN --tx-out TX_OUT
                                                 --ttl SLOT_COUNT --fee LOVELACE
                                                 --tx-body-file FILEPATH
                                                 [--certificate FILEPATH]
  Build a transaction (low-level, inconvenient)

Available options:
  --tx-in TX_IN            The input transaction as TxId#TxIx where TxId is the
                           transaction hash and TxIx is the index.
  --tx-out TX_OUT          The ouput transaction as TxOut+Lovelace where TxOut
                           is the hex encoded address followed by the amount in
                           Lovelace.
  --ttl SLOT_COUNT         Time to live (in slots).
  --fee LOVELACE           The fee amount in Lovelace.
  --tx-body-file FILEPATH  Output filepath of the TxBody.
  --certificate FILEPATH   Filepath of the certificate. This encompasses all
                           types of certificates (stake pool certificates, stake
                           key certificates etc)
</pre></div>
</div>
<p>Yes, this is a very inconvenient way to build transactions, but at least you’ll
be able to say you understand the UTxO model a little better.</p>
<p>So we have the transaction input and output. The TxIn uses “TxId#TxIx” syntax.
That will be the TxIn we got from the <code class="docutils literal notranslate"><span class="pre">initial-txin</span></code> command. The TxOut uses
“TxOut+Lovelace” syntax. We’ll build that by taking the address from the
<code class="docutils literal notranslate"><span class="pre">address</span> <span class="pre">build</span></code> command from the previous section and adding “+500000000” for
the value we want to move to that address.</p>
<p>Next we have the TTL. In Shelley every transaction has an expiry slot. If the
transaction does not make it into the chain by this slot then it will be
considered invalid and will never be added to the chain (on that fork). This is
generally helpful to avoid potentially valid transactions from floating around
for ever. It let’s us guarantee that after some point we definitely do not have
to worry about them any more. For boring technical reasons it is required
rather than optional. Pick a slot number that is sufficiently far into the
future. You can look at the node log files or query the node’s tip to find the
current slot number.</p>
<p>Finally we have the fee. In Shelley the transaction fee is explicit, rather
than implicitly being the difference between the inputs and the outputs.
Furthermore the inputs and outputs + fee, must balance <em>exactly</em>. You can still
choose the fee, it just has to be above the minimum fee. With the demo genesis
we made, the fees are zero so we can ignore this complication for now.</p>
<p>So we build the unsigned transaction and place it in <code class="docutils literal notranslate"><span class="pre">example/tx1.txbody</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley transaction build-raw \
    --tx-in  76cb9794a896ee640dcb54bd932f3a0ca6012aa99cb7d767aec9f4d717c88d7b#0 \
    --tx-out 82065820cd44104b49b97dae659dabf040cc7d588ea28e52addffc66fd126bb23be87451+500000000 \
    --ttl 3600 \
    --fee 0 \
    --tx-body-file example/tx1.txbody
</pre></div>
</div>
</div>
<div class="section" id="making-a-signed-transaction">
<h3>Making a signed transaction<a class="headerlink" href="#making-a-signed-transaction" title="Permalink to this headline">¶</a></h3>
<p>The next step is to sign it. Shelley transactions sometimes need lots of
signatures, e.g. when registering stake pools, or spending from multi-sig
addresses. Typically however we just need one signature for each address we use
in inputs (that’s one per address, not one per input UTxO, if there are multiple
inputs from the same address).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley transaction sign
Usage: cardano-cli shelley transaction sign --tx-body-file FILEPATH
                                            --signing-key-file FILEPATH
                                            (--mainnet | --testnet-magic INT)
                                            --tx-file FILEPATH
  Sign a transaction

Available options:
  --tx-body-file FILEPATH  Input filepath of the TxBody.
  --signing-key-file FILEPATH
                           Input filepath of the signing key (one or more).
  --mainnet                Use the mainnet magic id.
  --testnet-magic INT      Specify a testnet magic id.
  --tx-file FILEPATH       Output filepath of the Tx.
</pre></div>
</div>
<p>In our example we need just the one signature, using the <code class="docutils literal notranslate"><span class="pre">utxo1.skey</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley transaction sign \
  --tx-body-file example/tx1.txbody \
  --signing-key-file example/utxo-keys/utxo1.skey \
  --testnet-magic 42 \
  --tx-file example/tx1.tx
</pre></div>
</div>
</div>
<div class="section" id="submitting-the-signed-transaction">
<h3>Submitting the signed transaction<a class="headerlink" href="#submitting-the-signed-transaction" title="Permalink to this headline">¶</a></h3>
<p>Finally we need to submit the signed transaction</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cardano-cli shelley transaction submit
Usage: cardano-cli shelley transaction submit --tx-file FILEPATH
                                              (--mainnet | --testnet-magic INT)
  Submit a transaction to the local node whose Unix domain socket is obtained
  from the CARDANO_NODE_SOCKET_PATH enviromnent variable.

Available options:
  --tx-file FILEPATH       Filepath of the transaction you intend to submit.
  --mainnet                Use the mainnet magic id.
  --testnet-magic INT      Specify a testnet magic id.
</pre></div>
</div>
<p>This command also needs the <code class="docutils literal notranslate"><span class="pre">CARDANO_NODE_SOCKET_PATH</span></code> like the other commands
that need to talk to a local node. And as mentioned above in the section on
querying the node, we have to specify <code class="docutils literal notranslate"><span class="pre">--testnet-magic</span> <span class="pre">42</span></code>, otherwise it
defaults to mainnet and then the handshake with the node would fail.</p>
<p>So let’s do it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CARDANO_NODE_SOCKET_PATH</span><span class="o">=</span><span class="n">example</span><span class="o">/</span><span class="n">node1</span><span class="o">/</span><span class="n">node</span><span class="o">.</span><span class="n">sock</span> \
    <span class="n">cardano</span><span class="o">-</span><span class="n">cli</span> <span class="n">shelley</span> <span class="n">transaction</span> <span class="n">submit</span> \
      <span class="o">--</span><span class="n">tx</span><span class="o">-</span><span class="n">file</span> <span class="n">example</span><span class="o">/</span><span class="n">tx1</span><span class="o">.</span><span class="n">tx</span> \
      <span class="o">--</span><span class="n">testnet</span><span class="o">-</span><span class="n">magic</span> <span class="mi">42</span>
</pre></div>
</div>
<p>If we now go look at the node logs (or stdout) for node1 we should see that
the transaction was accepted into the mempool, and some seconds later we should
see that the next block included the transaction.</p>
<p>We can also check using the UTxO query, but now using the new address we moved
the funds to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CARDANO_NODE_SOCKET_PATH</span><span class="o">=</span><span class="n">example</span><span class="o">/</span><span class="n">node1</span><span class="o">/</span><span class="n">node</span><span class="o">.</span><span class="n">sock</span> \
    <span class="n">cardano</span><span class="o">-</span><span class="n">cli</span> <span class="n">shelley</span> <span class="n">query</span> <span class="n">filtered</span><span class="o">-</span><span class="n">utxo</span> \
      <span class="o">--</span><span class="n">testnet</span><span class="o">-</span><span class="n">magic</span> <span class="mi">42</span> \
      <span class="o">--</span><span class="n">address</span> <span class="mi">82065820</span><span class="n">cd44104b49b97dae659dabf040cc7d588ea28e52addffc66fd126bb23be87451</span>

                           <span class="n">TxHash</span>                                 <span class="n">TxIx</span>        <span class="n">Lovelace</span>
<span class="o">----------------------------------------------------------------------------------------</span>
<span class="n">a961d5e14a3a2cd886787d04a2c14721a4ca6d7f15b6ed52ddc0900659200046</span>     <span class="mi">0</span>         <span class="mi">500000000</span>
</pre></div>
</div>
<p>So since the fees were zero we move the full amount, and we have a new UTxO
entry at our target address.</p>
<p>From here we can do more “normal” transactions to move funds to other addresses
or build and submit transactions with special certificates in them.</p>
</div>
</div>
<div class="section" id="submitting-a-normal-transaction">
<h2>Submitting a “normal” transaction<a class="headerlink" href="#submitting-a-normal-transaction" title="Permalink to this headline">¶</a></h2>
<p>TODO: normal txs, much like above, then certs, stake addresses etc.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, IOHK

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>